{"version":3,"sources":["../../../src/components/popup.js"],"names":["React","createRef","PropTypes","BaseControl","getDynamicPosition","ANCHOR_POSITION","crispPercentage","crispPixel","propTypes","Object","assign","className","string","longitude","number","isRequired","latitude","altitude","offsetLeft","offsetTop","tipSize","closeButton","bool","closeOnClick","anchor","oneOf","keys","dynamicPosition","sortByDepth","onClose","func","defaultProps","Popup","evt","props","captureClick","stopPropagation","target","eventManager","_context","once","e","componentDidMount","forceUpdate","_getPosition","x","y","viewport","content","_contentRef","current","padding","width","height","selfWidth","clientWidth","selfHeight","clientHeight","_getContainerStyle","z","positionType","anchorPosition","left","top","el","_containerRef","xPercentage","yPercentage","style","position","transform","display","undefined","zIndex","Math","floor","_renderTip","borderWidth","_renderContent","children","onClick","_onClick","_render","project","containerStyle"],"mappings":"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","sourcesContent":["// @flow\n// Copyright (c) 2015 Uber Technologies, Inc.\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport * as React from 'react';\nimport {createRef} from 'react';\nimport PropTypes from 'prop-types';\nimport BaseControl from './base-control';\n\nimport {getDynamicPosition, ANCHOR_POSITION} from '../utils/dynamic-position';\n\nimport type {BaseControlProps} from './base-control';\nimport {crispPercentage, crispPixel} from '../utils/crisp-pixel';\nimport type {PositionType} from '../utils/dynamic-position';\n\nconst propTypes = Object.assign({}, BaseControl.propTypes, {\n  // Custom className\n  className: PropTypes.string,\n  // Longitude of the anchor point\n  longitude: PropTypes.number.isRequired,\n  // Latitude of the anchor point\n  latitude: PropTypes.number.isRequired,\n  // Altitude of the anchor point\n  altitude: PropTypes.number,\n  // Offset from the left\n  offsetLeft: PropTypes.number,\n  // Offset from the top\n  offsetTop: PropTypes.number,\n  // Size of the tip\n  tipSize: PropTypes.number,\n  // Whether to show close button\n  closeButton: PropTypes.bool,\n  // Whether to close on click\n  closeOnClick: PropTypes.bool,\n  // The popup's location relative to the coordinate\n  anchor: PropTypes.oneOf(Object.keys(ANCHOR_POSITION)),\n  // Whether the popup anchor should be auto-adjusted to fit within the container\n  dynamicPosition: PropTypes.bool,\n  // Whether popups should be sorted by depth. Useful when using multiple popups with tilted map.\n  sortByDepth: PropTypes.bool,\n  // Callback when component is closed\n  onClose: PropTypes.func\n});\n\nconst defaultProps = Object.assign({}, BaseControl.defaultProps, {\n  className: '',\n  altitude: 0,\n  offsetLeft: 0,\n  offsetTop: 0,\n  tipSize: 10,\n  anchor: 'bottom',\n  dynamicPosition: true,\n  sortByDepth: false,\n  closeButton: true,\n  closeOnClick: true,\n  onClose: () => {}\n});\n\nexport type PopupProps = BaseControlProps & {\n  className: string,\n  longitude: number,\n  latitude: number,\n  altitude: number,\n  offsetLeft: number,\n  offsetTop: number,\n  tipSize: number,\n  closeButton: boolean,\n  closeOnClick: boolean,\n  anchor: PositionType,\n  dynamicPosition: boolean,\n  sortByDepth: boolean,\n  onClose: Function\n};\n\n/*\n * PureComponent doesn't update when context changes.\n * The only way is to implement our own shouldComponentUpdate here. Considering\n * the parent component (StaticMap or InteractiveMap) is pure, and map re-render\n * is almost always triggered by a viewport change, we almost definitely need to\n * recalculate the popup's position when the parent re-renders.\n */\nexport default class Popup extends BaseControl<PopupProps, *, HTMLDivElement> {\n  static propTypes = propTypes;\n  static defaultProps = defaultProps;\n\n  _closeOnClick: boolean = false;\n  _contentRef: {current: null | HTMLDivElement} = createRef();\n\n  componentDidMount() {\n    super.componentDidMount();\n    // Container just got a size, re-calculate position\n    this.forceUpdate();\n  }\n\n  _getPosition(x: number, y: number): PositionType {\n    const {viewport} = this._context;\n    const {anchor, dynamicPosition, tipSize} = this.props;\n    const content = this._contentRef.current;\n\n    if (content) {\n      return dynamicPosition\n        ? getDynamicPosition({\n            x,\n            y,\n            anchor,\n            padding: tipSize,\n            width: viewport.width,\n            height: viewport.height,\n            selfWidth: content.clientWidth,\n            selfHeight: content.clientHeight\n          })\n        : anchor;\n    }\n\n    return anchor;\n  }\n\n  _getContainerStyle(x: number, y: number, z: number, positionType: PositionType) {\n    const {viewport} = this._context;\n    const {offsetLeft, offsetTop, sortByDepth} = this.props;\n    const anchorPosition = ANCHOR_POSITION[positionType];\n    const left = x + offsetLeft;\n    const top = y + offsetTop;\n\n    const el = this._containerRef.current;\n    const xPercentage = crispPercentage(el, -anchorPosition.x * 100);\n    const yPercentage = crispPercentage(el, -anchorPosition.y * 100, 'y');\n    const style = {\n      position: 'absolute',\n      transform: `\n        translate(${xPercentage}%, ${yPercentage}%)\n        translate(${crispPixel(left)}px, ${crispPixel(top)}px)\n      `,\n      display: undefined,\n      zIndex: undefined\n    };\n\n    if (!sortByDepth) {\n      return style;\n    }\n    if (z > 1 || z < -1 || x < 0 || x > viewport.width || y < 0 || y > viewport.height) {\n      // clipped\n      style.display = 'none';\n    } else {\n      // use z-index to rearrange components\n      style.zIndex = Math.floor(((1 - z) / 2) * 100000);\n    }\n\n    return style;\n  }\n\n  _onClick = evt => {\n    if (this.props.captureClick) {\n      evt.stopPropagation();\n    }\n\n    if (this.props.closeOnClick || evt.target.className === 'mapboxgl-popup-close-button') {\n      this.props.onClose();\n\n      const {eventManager} = this._context;\n      if (eventManager) {\n        // Using with InteractiveMap\n        // After we call `onClose` on `anyclick`, this component will be unmounted\n        // at which point we unregister the event listeners and stop blocking propagation.\n        // Then after a short delay a `click` event will fire\n        // Attach a one-time event listener here to prevent it from triggering `onClick` of the base map\n        eventManager.once('click', e => e.stopPropagation(), evt.target);\n      }\n    }\n  };\n\n  _renderTip(positionType: PositionType) {\n    const {tipSize} = this.props;\n\n    return <div key=\"tip\" className=\"mapboxgl-popup-tip\" style={{borderWidth: tipSize}} />;\n  }\n\n  _renderContent() {\n    const {closeButton, children} = this.props;\n    // If eventManager does not exist (using with static map), listen to React event\n    const onClick = this._context.eventManager ? null : this._onClick;\n\n    return (\n      <div\n        key=\"content\"\n        ref={this._contentRef}\n        className=\"mapboxgl-popup-content\"\n        onClick={onClick}\n      >\n        {closeButton && (\n          <button key=\"close-button\" className=\"mapboxgl-popup-close-button\" type=\"button\">\n            Ã—\n          </button>\n        )}\n        {children}\n      </div>\n    );\n  }\n\n  _render() {\n    const {className, longitude, latitude, altitude} = this.props;\n\n    const [x, y, z] = this._context.viewport.project([longitude, latitude, altitude]);\n\n    const positionType = this._getPosition(x, y);\n    const containerStyle = this._getContainerStyle(x, y, z, positionType);\n\n    return (\n      <div\n        className={`mapboxgl-popup mapboxgl-popup-anchor-${positionType} ${className}`}\n        style={containerStyle}\n        ref={this._containerRef}\n      >\n        {this._renderTip(positionType)}\n        {this._renderContent()}\n      </div>\n    );\n  }\n}\n"],"file":"popup.js"}