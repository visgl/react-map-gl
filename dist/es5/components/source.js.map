{"version":3,"sources":["../../../src/components/source.js"],"names":["propTypes","type","PropTypes","string","isRequired","id","sourceCounter","Source","props","map","_map","sourceOptions","_sourceOptions","changedKey","changedKeyCount","key","source","getSource","_createSource","setData","data","updateImage","url","coordinates","setCoordinates","setUrl","setTiles","tiles","console","warn","off","_updateSource","requestAnimationFrame","style","_loaded","removeSource","addSource","context","on","React","Children","children","child","_render","bind","PureComponent"],"mappings":"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","sourcesContent":["// @flow\n// Copyright (c) 2015 Uber Technologies, Inc.\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport * as React from 'react';\nimport {PureComponent, cloneElement} from 'react';\nimport PropTypes from 'prop-types';\nimport MapContext from './map-context';\nimport assert from '../utils/assert';\nimport deepEqual from '../utils/deep-equal';\n\nimport type {MapContextProps} from './map-context';\n\nconst propTypes = {\n  type: PropTypes.string.isRequired,\n  id: PropTypes.string\n};\n\ntype SourceProps = {\n  id?: string,\n  type: string,\n  children?: any\n};\n\nlet sourceCounter = 0;\n\nexport default class Source<Props: SourceProps> extends PureComponent<Props> {\n  static propTypes = propTypes;\n\n  constructor(props: Props) {\n    super(props);\n    this.id = props.id || `jsx-source-${sourceCounter++}`;\n    this.type = props.type;\n  }\n\n  componentWillUnmount() {\n    /* global requestAnimationFrame */\n    // Do not remove source immediately because the\n    // dependent <Layer>s' componentWillUnmount() might not have been called\n    // Removing source before dependent layers will throw error\n    // TODO - find a more robust solution\n    const map = this._map;\n    if (map) {\n      map.off('styledata', this._updateSource);\n      requestAnimationFrame(() => {\n        if (map.style && map.style._loaded) {\n          map.removeSource(this.id);\n        }\n      });\n    }\n  }\n\n  id: string;\n  type: string;\n  _map: any = null;\n  _sourceOptions: any = {};\n\n  getSource() {\n    const map = this._map;\n    return map && map.style && map.getSource(this.id);\n  }\n\n  _createSource(sourceOptions: any) {\n    const map = this._map;\n    if (map.style && map.style._loaded) {\n      map.addSource(this.id, sourceOptions);\n    }\n  }\n\n  /* eslint-disable complexity */\n  _updateSource = () => {\n    const {type, _map: map} = this;\n    if (!map) {\n      return;\n    }\n\n    const {_sourceOptions: sourceOptions, props} = this;\n    assert(!props.id || props.id === this.id, 'source id changed');\n    assert(props.type === type, 'source type changed');\n\n    let changedKey = '';\n    let changedKeyCount = 0;\n\n    for (const key in props) {\n      if (key !== 'children' && key !== 'id' && !deepEqual(sourceOptions[key], props[key])) {\n        sourceOptions[key] = props[key];\n        changedKey = key;\n        changedKeyCount++;\n      }\n    }\n\n    const source = this.getSource();\n    if (!source) {\n      this._createSource(sourceOptions);\n      return;\n    }\n    if (!changedKeyCount) {\n      return;\n    }\n    if (type === 'geojson') {\n      source.setData(sourceOptions.data);\n    } else if (type === 'image') {\n      source.updateImage({url: sourceOptions.url, coordinates: sourceOptions.coordinates});\n    } else if (\n      (type === 'canvas' || type === 'video') &&\n      changedKeyCount === 1 &&\n      changedKey === 'coordinates'\n    ) {\n      source.setCoordinates(sourceOptions.coordinates);\n    } else if (type === 'vector' && source.setUrl) {\n      // Added in 1.12.0:\n      // vectorTileSource.setTiles\n      // vectorTileSource.setUrl\n      switch (changedKey) {\n        case 'url':\n          source.setUrl(sourceOptions.url);\n          break;\n        case 'tiles':\n          source.setTiles(sourceOptions.tiles);\n          break;\n        default:\n      }\n    } else {\n      // eslint-disable-next-line\n      console.warn(`Unable to update <Source> prop: ${changedKey}`);\n    }\n  };\n  /* eslint-enable complexity */\n\n  _render(context: MapContextProps) {\n    if (!this._map && context.map) {\n      this._map = context.map;\n      this._map.on('styledata', this._updateSource);\n    }\n    this._updateSource();\n    return React.Children.map(\n      this.props.children,\n      child =>\n        child &&\n        cloneElement(child, {\n          source: this.id\n        })\n    );\n  }\n\n  render() {\n    return <MapContext.Consumer>{this._render.bind(this)}</MapContext.Consumer>;\n  }\n}\n"],"file":"source.js"}